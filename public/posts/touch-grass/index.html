






<!doctype html>
<html
  lang="en-us"
  dir="ltr"
  class="scroll-smooth"
  data-default-appearance="dark"
  data-auto-appearance="true"
><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#FFFFFF" />
  
  <title>Touch grass &middot; defectivemaker</title>
    <meta name="title" content="Touch grass &middot; defectivemaker" />
  
  
  
  
  
  <script
    type="text/javascript"
    src="/js/appearance.min.8a082f81b27f3cb2ee528df0b0bdc39787034cf2cc34d4669fbc9977c929023c.js"
    integrity="sha256-iggvgbJ/PLLuUo3wsL3Dl4cDTPLMNNRmn7yZd8kpAjw="
  ></script>
  
  
  
  
  
  
  
    
  
  
  <link
    type="text/css"
    rel="stylesheet"
    href="/css/main.bundle.min.48535ac70d65dd8e3abda7c887626471b24eff632b187d71cbf4ff671eaa0221.css"
    integrity="sha256-SFNaxw1l3Y46vafIh2JkcbJO/2MrGH1xy/T/Zx6qAiE="
  />
  
  
  
  
  
  
  
  <meta
    name="description"
    content="
      
        Touch grass is a common slang term referring to people that are chronically online, sometimes you just need to go outside and touch some grass and be in the real world. That&rsquo;s what this is, a way to go outside and explore Australia.
Introduction #Sprawled across Australia is a vast infrastructure that is completely untapped by the public, these landmarks fill big cities and small towns alike with its iconic presence.
      
    "
  />
  
  
  
  <link rel="canonical" href="http://localhost:1313/posts/touch-grass/" />
  
  
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="http://localhost:1313/posts/touch-grass/">
  <meta property="og:site_name" content="defectivemaker">
  <meta property="og:title" content="Touch grass">
  <meta property="og:description" content="Touch grass is a common slang term referring to people that are chronically online, sometimes you just need to go outside and touch some grass and be in the real world. That’s what this is, a way to go outside and explore Australia.
Introduction #Sprawled across Australia is a vast infrastructure that is completely untapped by the public, these landmarks fill big cities and small towns alike with its iconic presence.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-27T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-06-27T00:00:00+00:00">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Touch grass">
  <meta name="twitter:description" content="Touch grass is a common slang term referring to people that are chronically online, sometimes you just need to go outside and touch some grass and be in the real world. That’s what this is, a way to go outside and explore Australia.
Introduction #Sprawled across Australia is a vast infrastructure that is completely untapped by the public, these landmarks fill big cities and small towns alike with its iconic presence.">

  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "Touch grass",
    "headline": "Touch grass",
    
    "abstract": "\u003cp\u003eTouch grass is a common slang term referring to people that are chronically online, sometimes you just need to go outside and touch some grass and be in the real world. That\u0026rsquo;s what this is, a way to go outside and explore Australia.\u003c\/p\u003e\n\u003ch2 id=\u0022introduction\u0022 class=\u0022relative group\u0022\u003eIntroduction \u003cspan class=\u0022absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100\u0022\u003e\u003ca class=\u0022group-hover:text-primary-300 dark:group-hover:text-neutral-700\u0022 style=\u0022text-decoration-line: none !important;\u0022 href=\u0022#introduction\u0022 aria-label=\u0022Anchor\u0022\u003e#\u003c\/a\u003e\u003c\/span\u003e\u003c\/h2\u003e\u003cp\u003eSprawled across Australia is a vast infrastructure that is completely untapped by the public, these landmarks fill big cities and small towns alike with its iconic presence.\u003c\/p\u003e",
    "inLanguage": "en-us",
    "url" : "http:\/\/localhost:1313\/posts\/touch-grass\/",
    "author" : {
      "@type": "Person",
      "name": ""
    },
    "copyrightYear": "2024",
    "dateCreated": "2024-06-27T00:00:00\u002b00:00",
    "datePublished": "2024-06-27T00:00:00\u002b00:00",
    
    "dateModified": "2024-06-27T00:00:00\u002b00:00",
    
    
    
    "mainEntityOfPage": "true",
    "wordCount": "2495"
  }
  </script>
    
    <script type="application/ld+json">
    {
   "@context": "https://schema.org",
   "@type": "BreadcrumbList",
   "itemListElement": [
     {
       "@type": "ListItem",
       "item": "http://localhost:1313/",
       "name": "Your Name",
       "position": 1
     },
     {
       "@type": "ListItem",
       "item": "http://localhost:1313/posts/",
       "name": "Posts",
       "position": 2
     },
     {
       "@type": "ListItem",
       "item": "http://localhost:1313/categories/cyber/",
       "name": "Cyber",
       "position": 3
     },
     {
       "@type": "ListItem",
       "name": "Touch Grass",
       "position": 4
     }
   ]
 }
  </script>

  
  
  
  
  






  
  

  
  
    


  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });

  </script>



<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                
            ]
        });
    });
</script>

  
</head>
<body
    class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"
  >
    <div id="the-top" class="absolute flex self-center">
      <a
        class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600"
        href="#main-content"
        ><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span
        >Skip to main content</a
      >
    </div>
    
    
      <header class="py-6 font-semibold text-neutral-900 dark:text-neutral sm:py-10 print:hidden">
  <nav class="flex items-start justify-between sm:items-center">
    
    <div class="flex flex-row items-center">
      
  <a
    class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2"
    rel="me"
    href="/"
    >defectivemaker</a
  >

    </div>
    
    
      <ul class="flex list-none flex-col text-end sm:flex-row">
        
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                <a
                  href=""
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >About</span
                    >
                  </a
                >
              
            </li>
          
            
            <li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5">
              
                <a
                  href="/posts/"
                  title=""
                  
                  ><span
                      class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"
                      >Posts</span
                    >
                  </a
                >
              
            </li>
          
          
        
      </ul>
    
  </nav>
</header>

    
    <div class="relative flex grow flex-col">
      <main id="main-content" class="grow">
        
  <article>
    <header class="max-w-prose">
      
        <ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden">
  
  
    
  
    
  
  <li class="hidden inline">
    <a
      class="dark:underline-neutral-600 decoration-neutral-300 hover:underline"
      href="/"
      >Your Name</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class=" inline">
    <a
      class="dark:underline-neutral-600 decoration-neutral-300 hover:underline"
      href="/posts/"
      >Posts</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="hidden inline">
    <a
      class="dark:underline-neutral-600 decoration-neutral-300 hover:underline"
      href="/posts/touch-grass/"
      >Touch grass</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

</ol>


      
      <h1 class="mb-8 mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        Touch grass
      </h1>
      
        <div class="mb-10 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
          





  
  



  

  
  
    
  

  

  
    
  

  
    
  

  


  <div class="flex flex-row flex-wrap items-center">
    
    
      <time datetime="2024-06-27 00:00:00 &#43;0000 UTC">June 27, 2024</time><span class="px-2 text-primary-500">&middot;</span><span>2495 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">12 mins</span>
    

    
    
  </div>

  
  


        </div>
      
      
    </header>
    <section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row">
      
        <div class="order-first px-0 lg:order-last lg:max-w-xs lg:ps-8">
          <div class="toc pe-5 lg:sticky lg:top-10 print:hidden">
            <details open class="-ms-5 mt-0 overflow-hidden rounded-lg ps-5">
  <summary
    class="block cursor-pointer bg-neutral-100 py-1 ps-5 text-lg font-semibold text-neutral-800 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden"
  >
    Table of Contents
  </summary>
  <div class="border-s border-dotted border-neutral-300 py-2 ps-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#working-with-wi-fi">Working with Wi-Fi</a></li>
    <li><a href="#creating-a-client--server">Creating a Client + Server</a></li>
    <li><a href="#designing-the-user-experience">Designing the user experience</a></li>
    <li><a href="#real-time-notifications">Real time notifications</a></li>
    <li><a href="#infrastructure">Infrastructure</a></li>
    <li><a href="#security-is-important">Security is important!</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
  </div>
</details>

          </div>
        </div>
      
      <div class="min-h-0 min-w-0 max-w-prose grow">
        <p>Touch grass is a common slang term referring to people that are chronically online, sometimes you just need to go outside and touch some grass and be in the real world. That&rsquo;s what this is, a way to go outside and explore Australia.</p>
<h2 id="introduction" class="relative group">Introduction <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#introduction" aria-label="Anchor">#</a></span></h2><p>Sprawled across Australia is a vast infrastructure that is completely untapped by the public, these landmarks fill big cities and small towns alike with its iconic presence.</p>
<p>What I am referring to is the &ldquo;Telstra Free Wi-Fi&rdquo; hotspots that are all around Australia.</p>
<p>





<figure>
    
    








  
    <picture
      class="mx-auto my-0 rounded-md"
      
    >
      
      
      
      
        <source
          
            srcset="/posts/touch-grass/wifi-hotspot_hu7859315461365272825.webp 330w,/posts/touch-grass/wifi-hotspot_hu5954192951844202563.webp 660w
            
              
                ,/posts/touch-grass/wifi-hotspot_hu6710285791860671195.webp 1024w
              
            
            
              
                ,/posts/touch-grass/wifi-hotspot_hu6710285791860671195.webp 1024w
              
            "
          
          sizes="100vw"
          type="image/webp"
        />
      
      <img
        width="1024"
        height="538"
        class="mx-auto my-0 rounded-md"
        alt="Wifi Hotspot"
        loading="lazy" decoding="async"
        
          src="/posts/touch-grass/wifi-hotspot_hu7227068140239516553.jpg"
          srcset="/posts/touch-grass/wifi-hotspot_hu18085176755170074556.jpg 330w,/posts/touch-grass/wifi-hotspot_hu7227068140239516553.jpg 660w
          
            ,/posts/touch-grass/wifi-hotspot.jpg 1024w
          
          
            ,/posts/touch-grass/wifi-hotspot.jpg 1024w
          "
          sizes="100vw"
        
      />
    </picture>
  


</figure>
</p>
<p>I thought it would be fun to do something with these, there are thousands all around the country and no one really uses them. I made a game for myself and decided to travel around Australia using the hotspots as an excuse to explore the country. I did a little roadtrip for a month and went from Sydney to Melbourne to Adelaide to Uluru and then back to Sydney. Within this trip I found hundreds of hotspots in small towns and big cities, I even found one in the middle of the outback, near Uluru. I ended up having a super cool adventure and I thought it would be a great idea to make a sort of adventure game out of it (the photos I took from the trip are on the website). So I present you <a href="https://touchgrass.au" target="_blank" rel="noreferrer">Touch grass</a></p>
<p>





<figure>
    
    








  
    <picture
      class="mx-auto my-0 rounded-md"
      
    >
      
      
      
      
        <source
          
            srcset="/posts/touch-grass/landing_hu13191158869269358745.webp 330w,/posts/touch-grass/landing_hu16336882020470962371.webp 660w
            
              ,/posts/touch-grass/landing_hu6002484132148946071.webp 1024w
            
            
              ,/posts/touch-grass/landing_hu6484962767126591481.webp 1320w
            "
          
          sizes="100vw"
          type="image/webp"
        />
      
      <img
        width="1359"
        height="762"
        class="mx-auto my-0 rounded-md"
        alt="Landing page"
        loading="lazy" decoding="async"
        
          src="/posts/touch-grass/landing_hu473000958820127691.png"
          srcset="/posts/touch-grass/landing_hu7585928657927907488.png 330w,/posts/touch-grass/landing_hu473000958820127691.png 660w
          
            ,/posts/touch-grass/landing_hu9996835156218006922.png 1024w
          
          
            ,/posts/touch-grass/landing_hu13476597063514546529.png 1320w
          "
          sizes="100vw"
        
      />
    </picture>
  


</figure>
</p>
<p>To play the game, you have to buy a physical device, the device will then wait until you are at a Telstra Wi-Fi hotspot and ping my server to know that you have reached one. You will receive a notification from the web app on your phone which will then allow you to confirm that you are actually there, gaining you points.</p>
<p>This post will be a deep dive in the technical engineering effort of making this project, including the fine grained details of the wifi handshake as well as how I implemented the technology stack. This post is targeted to a more technical audience, you have been warned!</p>
<h2 id="working-with-wi-fi" class="relative group">Working with Wi-Fi <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#working-with-wi-fi" aria-label="Anchor">#</a></span></h2><p>The initial investigation began by understanding the mechanism of how you connect to the hotspot. I have one near where I live so I was able to do some field testing. The Telstra Wi-Fi hotspot has a captive portal that initially opens up when connecting to the access point, on the captive portal you must agree to the terms and conditions and then you have Wi-Fi. To understand how I could connect my Raspberry Pi to the Wi-Fi I needed to understand how this captive portal works. Using tools like Burp Suite and the web developer tools on the browser allowed me to understand a bit better what was going on under the hood.</p>
<p>What happens when you don&rsquo;t agree to the terms and conditions? <a href="https://en.wikipedia.org/wiki/Captive_portal" target="_blank" rel="noreferrer">Captive portals</a> work by redirecting all traffic from the access point if they see that the client is not authenticated, the main way they do this is through the MAC address. If the client is not authenticated, they either intercept web traffic and return a 302 redirect or they use a DNS server to route all unautheticated requests to their captive portal<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>. In this case, I believe it uses a 302 redirect because when I curl any site (without going through portal) I get a 302</p>
<pre tabindex="0"><code>$ curl http://example.com
&lt;html&gt;&lt;body&gt;You are being &lt;a href=&#39;https://apac.network-auth.com/splash/NAxIVbNc.5.167/?mac=0C%3A8D%3ADB%3A5E%3A31%3ACC&amp;real_ip=10.174.39.37&amp;client_ip=10.123.81.209&amp;client_mac=00:C0:CA:B4:8C:56&amp;vap=5&amp;a=632667547e7cd3e0466547863e1207a8c0c0c549&amp;b=11747327&amp;auth_version=5&amp;key=d7f118effbe89d7e0767520cb8e65b5c1f8ea9cb&amp;acl_ver=P8136049V2&amp;continue_url=http%3A%2F%2Fexample.com%2F&#39;&gt;redirected&lt;/a&gt;.&lt;/body&gt;&lt;/html&gt;
</code></pre><p>The domain network-auth.com is associated with <a href="https://documentation.meraki.com/General_Administration/Cross-Platform_Content/Splash_Page" target="_blank" rel="noreferrer">Cisco Meraki</a> an enterprise cloud controlled Wi-Fi routing system.</p>
<p>Deciphering the variables:</p>
<ul>
<li>mac: the access point&rsquo;s mac address</li>
<li>real_ip: the IP address of the hotspot</li>
<li>client_ip: the IP the DHCP server will give the client</li>
<li>client_mac: the client&rsquo;s mac address</li>
<li>vap: virtual access point (vap) allows owners to have more fine grain control over AP</li>
<li>acl_ver: refers to the access control list which defines the rules of the AP</li>
<li>continue_url: once authenticated where it should redirect to</li>
<li>key: some key used for authentication, changes after every attempted authentication</li>
<li>a: after doing some field testing, I found out &lsquo;a&rsquo; refers to the physical payphone, each payphone will have a different &lsquo;a&rsquo;</li>
<li>b: after doing some field testing, I found out &lsquo;b&rsquo; is a time count in seconds since X</li>
</ul>
<p>Looking through the captive portal&rsquo;s code. Pressing the agree button does this</p>
<pre tabindex="0"><code>onclick=
function() {
    var _request = new XMLHttpRequest();
    var url = &#39;https://apac.network-auth.com/splash/NAxIVbNc.5.167/grant?continue_url=CONTINUE_URL_PLACEHOLDER&#39;;
    _request.open(&#39;HEAD&#39;, window.location, true);
    _request.setRequestHeader(&#39;X-Requested-With&#39;, &#39;XMLHttpRequest&#39;);
    _request.onreadystatechange = function() {
    if (_request.readyState === 4) {
        var continue_url = _request.getResponseHeader(&#39;Continue-Url&#39;);
        window.location.href = url.replace(&#39;CONTINUE_URL_PLACEHOLDER&#39;, continue_url);
    };
    };
    _request.send(null);
})(); return false;
</code></pre><p>As we can see, hitting the endpoint <code>https://apac.network-auth.com/splash/NAxIVbNc.5.167/grant</code> will authorise a client. Manually trying to go this endpoint unfortunately didn&rsquo;t work. I figured out that the endpoint actually does the authentication from cookies that are generated when initially going to the captive portal. Once you use the cookies that you get from visiting the initial redirect, you use these cookies to authenticate yourself and then you have internet access.</p>
<p>Playing around with the paramters in the initial redirect (mac, real_ip, client_ip etc) didn&rsquo;t work very well so it seems they all need to be correct for the correct cookies to be generated. Now that I know the authentication method, I can easily recreate this with a few commands.</p>
<ol>
<li>Connect to the Access Point, the AP doesn&rsquo;t have security so anyone can connect
<code>sudo nmcli dev wifi connect 'Free Telstra Wi-Fi'</code></li>
<li>Use -L to follow redirect and store the cookies
<code>curl -c /tmp/cookies.txt -L http://google.com</code></li>
<li>Use cookies to authenticate to endpoint /grant (-b pass data into cookie header)
<code>curl -b /tmp/cookies.txt https://apac.network-auth.com/splash/NAxIVbNc.5.167/grant?continue_url=</code></li>
<li>Congratulations you are now authenticated</li>
</ol>
<h2 id="creating-a-client--server" class="relative group">Creating a Client + Server <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#creating-a-client--server" aria-label="Anchor">#</a></span></h2><p>My Raspberry Pi can successfully connect to the hotspot. Now what?</p>
<p>I will use use the information I have collected about the handshake to connect with the hotspot (mac, real_ip etc) and send this to my server, this allows a way for me to know if you have connected to a hotspot and then give you points.</p>
<p>I used Golang as my prefered choice for client-server communications because it is fast, lightweight and has built in networking capabilities. A simple Go server and client were setup to take in some data from the handshake, encrypt it and then send it over the internet to my server.</p>
<p>It was a bit of overkill and completely unneccessary but I also created a simple custom protocol for how the data was sent, this was done as a fun exercise and although it is not the best for maintenance and upgradability is was still fun.</p>
<p>The protcol sits on top of TCP and below TLS. Its a pretty basic way that allowed me to pack the data and send it as a chunk to the server. For extra extra redundancy, not only is the data encrypted using TLS but I encrypt the data before it is sent using AES-GCM for extra security. This means that you can&rsquo;t see the payload on device without the key (or reverse engineering).</p>
<p>The server checks the payload that comes in and does some checking through the header of the payload to ensure it is valid. It then decrypts the data and stores it in a PostgresDB.</p>
<h2 id="designing-the-user-experience" class="relative group">Designing the user experience <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#designing-the-user-experience" aria-label="Anchor">#</a></span></h2><p>The frontend framework is pretty standard. I&rsquo;m using Nextjs with NextUI and tailwind components for design. I incorporated features like a visual map to see which hotspots you have visited, data about how many hotspots you&rsquo;ve found and other useful statistics and I created a smooth mobile friendly user experience as it would primarily be used on a phone. Here are some screenshots of the app</p>
<p>





<figure>
    
    








  
    <picture
      class="mx-auto my-0 rounded-md"
      
    >
      
      
      
      
        <source
          
            
              srcset="/posts/touch-grass/ui-2_hu10513897008209324941.webp"
            
          
          sizes="100vw"
          type="image/webp"
        />
      
      <img
        width="363"
        height="754"
        class="mx-auto my-0 rounded-md"
        alt="UI 2"
        loading="lazy" decoding="async"
        
          src="/posts/touch-grass/ui-2.png"
        
      />
    </picture>
  


</figure>
{:style=&ldquo;width: 100%; display:block; margin-left:auto; margin-right:auto &ldquo;}\






<figure>
    
    








  
    <picture
      class="mx-auto my-0 rounded-md"
      
    >
      
      
      
      
        <source
          
            
              srcset="/posts/touch-grass/ui-1_hu13715412341955447744.webp"
            
          
          sizes="100vw"
          type="image/webp"
        />
      
      <img
        width="373"
        height="754"
        class="mx-auto my-0 rounded-md"
        alt="UI 1"
        loading="lazy" decoding="async"
        
          src="/posts/touch-grass/ui-1.png"
        
      />
    </picture>
  


</figure>
{:style=&ldquo;width: 100%; display:block; margin-left:auto; margin-right:auto &ldquo;}</p>
<h2 id="real-time-notifications" class="relative group">Real time notifications <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#real-time-notifications" aria-label="Anchor">#</a></span></h2><p>One thing I really wanted to get right was the notifications. I wanted a seamless and delay-free experience from when the Raspberry Pi connects to the hotspot. To do this I would need to integrate a notification system between the three parts of my app. The database, the backend and the frontend.</p>
<p><strong>Backend &lt;-&gt; Frontend</strong> \
A few options are possible when streaming data between the frontend and the backend, the main two are polling and websockets. Polling involves sending a request to the server every X seconds asking if it has received new information. This consumes a lot of bandwidth and the tradeoff is either constantly checking the backend (which is a lot of wasted bandwidth) and delays in receiving information (if you poll quite infrequently). A much better option is using a websocket which creates a two way connection between the client and the server. By using websockets we can instantly update the frontend with the new information once the backend has received it. This reduces bandwidth as messages are only sent when they have to, also this means there is no delay from when the backend gets it to when the frontend receives it.</p>
<pre tabindex="0"><code>// create websocket
const socket = new WebSocket(`wss://${apiUrl}/ws?jwt=${token}`);

// when a message is received, update the UI
socket.onmessage = (event) =&gt; {
  handleRecentEntry();
};
</code></pre><p><strong>DB &lt;-&gt; Server</strong> \
This was actually a bit trickier. To implement a real time update and trigger, I had to completely switch databases. I was initially using MySQL but since they were lacking real-time functionality, I opted for Postgres instead which had pg_notify() a handy feature that allows you to trigger a notification if a certain query passes.</p>
<pre tabindex="0"><code>
CREATE FUNCTION notify_insert()
RETURNS TRIGGER AS $$
BEGIN
PERFORM pg_notify(&#39;new_entry&#39;, NEW.deviceuuid);
RETURN NEW;
END;

$$
LANGUAGE plpgsql;

CREATE TRIGGER trigger_notify_insert
AFTER INSERT ON entries
FOR EACH ROW EXECUTE FUNCTION notify_insert();
</code></pre><p>This code listens for any INSERTs into the DB and triggers my go server which then sends the data to the client through the websocket.</p>
<h2 id="infrastructure" class="relative group">Infrastructure <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#infrastructure" aria-label="Anchor">#</a></span></h2><p>To build out the infrastructure I wanted to have a modular approach, something that was scalable in the case that millions of people are using the app, I also wanted it to be easy to deploy, upgrade, test etc. For this, I used Dockerfiles and docker-compose for an easy way to build up the infrastructure in one click. This would make it easy to transition to Kubernetes if I need to horizontally scale. The services that are running on the docker compose include the frontend server which uses Nextjs, the backend server that is run using Golang, this server interacts with both the frontend but also processes the data from the device which is sent once the device connects to a hotspot. I have a Postgres backend which has some runscripts for setup and to configure notifications and I also have an NGINX reverse proxy that redirects traffic and faces the internet.</p>
<p>Below is a diagram that pretty accurately shows how these components interact with each other and the flow of data through the system</p>
<pre class="mermaid">
graph TB
    subgraph User["User"]
        HD[Hardware Device<br>Raspberry Pi]
        Phone[Smartphone]
    end

    subgraph Server["Server Infrastructure"]
        NGINX[NGINX Reverse Proxy]
        NextJS[Next.js Frontend]
        GO[Go Application]
        DB[(PostgreSQL<br>with PostGIS)]
    end

    subgraph External["External"]
        WIFI{WiFi Hotspots}
    end

    %% Connections
    HD --"Connects to"--> WIFI
    HD --"Sends data<br>(TCP/8888)"--> GO
    Phone --"Accesses website<br>(HTTPS)"--> NGINX
    NGINX --"Proxies requests"--> NextJS
    NGINX --"Proxies API requests"--> GO
    NextJS --"Fetches/Sends data"--> GO
    GO --"Stores/Retrieves data"--> DB

    %% Hardware Device Details
    subgraph Hardware["Hardware Device Details"]
        BASH[Bash Script]
        GOCLIENT[Go Client]
    end

    HD --- Hardware
    BASH --"Runs"--> GOCLIENT

    %% Styling
    classDef server fill:#4a5568,stroke:#e2e8f0,stroke-width:2px,color:#e2e8f0;
    classDef external fill:#2c5282,stroke:#e2e8f0,stroke-width:2px,color:#e2e8f0;
    classDef hardware fill:#2f855a,stroke:#e2e8f0,stroke-width:2px,color:#e2e8f0;
    classDef phone fill:#b7791f,stroke:#e2e8f0,stroke-width:2px,color:#e2e8f0;
    classDef default color:#e2e8f0;

    class NGINX,NextJS,GO,DB server;
    class WIFI external;
    class HD,BASH,GOCLIENT hardware;
    class Phone phone;

    %% Set background color
    %%{init: {'theme': 'dark', 'themeVariables': { 'darkMode': true, 'background': '#1a202c', 'primaryColor': '#e2e8f0', 'secondaryColor': '#718096', 'tertiaryColor': '#4a5568' }}}%%
  </pre>
  
  
  <p>Designing and configuring the hardware device that will connect to the hotspot also involved some engineering work. Before I began, I considered creating an ios or android app however problems arose when I realised there were a lot of limitations involving interactions with the device and wifi connections and network requests. I thought getting the actual connection was a priority for the game and thought building a physical device was cooler than just an app.</p>
<p>In order to productionise and automate the setup of the raspberry pi, I created an ansible playbook that gets a freshly imaged RPi with Raspberry Pi OS Lite and fully configures the setup, this setup includes downloading the appropriate packages, cloning the github, generating some public/private keys (explained below), setting up the nmconnection (network manager connection) file, the bash script, the systemd service and the golang binary that runs on device.</p>
<h2 id="security-is-important" class="relative group">Security is important! <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#security-is-important" aria-label="Anchor">#</a></span></h2><p>Security is important and I wanted to harden the system from tampering and bypassing.</p>
<p>The first line of defence is outside threats. All data that is sent from the device to the server is sent using TLS and also encrpyted on device before it is sent out.</p>
<p>It is also hard to spoof the data to the server because a unique string is sent which is taken from the handshake with the hotspot, this is like a proof of contact, only if you have the string can you prove that you have been there.</p>
<p>I created an authentication system to ensure only people with the Pi can send data to my server. I did this by first generating a token once the user creates an account on my website. Once the user gets this token, I can setup their RPi by passing the token into the ansible setup script. The script generates a public private key pair and maps the token with the user id to the public key. When the device sends data back to the server, it signs the data with the private key and sends the user id with it. The server will only accept the data if the data that is sent can be validated with the user id&rsquo;s matching public key. This eliminates the risk of others forging payloads.</p>
<pre class="mermaid">sequenceDiagram
    participant User
    participant Website
    participant Ansible
    participant RPi as Raspberry Pi
    participant Server

    User->>Website: Create account
    Website->>Server: Generate token
    Server-->>Website: Return token
    Website-->>User: Display token

    User->>Ansible: Run setup script with token
    Ansible->>RPi: Generate public/private key pair
    Ansible->>Server: Send token, user ID, and public key
    Server->>Server: Map token & user ID to public key

    loop Data Collection
        RPi->>RPi: Collect WiFi hotspot data
        RPi->>RPi: Sign data with private key
        RPi->>Server: Send signed data with user ID
        Server->>Server: Retrieve public key for user ID
        Server->>Server: Verify signed data with public key
        alt Data verified
            Server->>Server: Process and store data
        else Verification fails
            Server->>Server: Reject data
        end
    end
  </pre>
  
  
  <h2 id="conclusion" class="relative group">Conclusion <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style="text-decoration-line: none !important;" href="#conclusion" aria-label="Anchor">#</a></span></h2><p>This is very much a work in progress, I just wanted something written down about some of the things that I have been working on recently. The application is pretty much ready to be played, I&rsquo;ll soon have a spot where you can purchase a device so you can play the game. There&rsquo;s still a lot of cool features that I&rsquo;m excited to add in the near future, I want this to be a fun way to get outside and go on an adventure, to see Australia including visiting small towns and places you would never normally visit.</p>
<p>Visit my site here: <a href="https://touchgrass.au" target="_blank" rel="noreferrer">https://touchgrass.au</a> to find out more.</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://www.chromium.org/chromium-os/chromiumos-design-docs/network-portal-detection/" target="_blank" rel="noreferrer">https://www.chromium.org/chromium-os/chromiumos-design-docs/network-portal-detection/</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

      </div>
    </section>
    <footer class="max-w-prose pt-8 print:hidden">
      
  <div class="flex">
    
    
    
    <div class="place-self-center">
      
      
      <div class="text-2xl sm:text-lg">
</div>
    </div>
  </div>


      

      
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="group flex" href="/posts/try-crack-me/">
              <span
                class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"
                ><span class="ltr:inline rtl:hidden">&larr;</span
                ><span class="ltr:hidden rtl:inline">&rarr;</span></span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Try crack me</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2024-05-22 00:00:00 &#43;0000 UTC">May 22, 2024</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
        </span>
      </div>
    </div>
  


      
    </footer>
  </article>

      </main>
      
        <div
          class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12"
          id="to-top"
          hidden="true"
        >
          <a
            href="#the-top"
            class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
            aria-label="Scroll to top"
            title="Scroll to top"
          >
            &uarr;
          </a>
        </div>
      <footer class="py-10 print:hidden">
  
  
  <div class="flex items-center justify-between">
    <div>
      
      
      
      
    </div>
    <div class="flex flex-row items-center">
      
      
      
      
    </div>
  </div>
  
  
</footer>

    </div>
  </body>
</html>
